<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR View</title>
    <script src="node_modules/three/build/three.min.js"></script>
    <script src="node_modules/@ar-js-org/ar.js/three.js/build/ar-threex.js"></script>
    
    <script src="js/OBJLoader.js"></script>
    <script src="js/MTLLoader.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; }
        #ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; font-size: 2em; z-index: 1000;">
        Please allow camera access and point to the Hiro marker.
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const modelPath = urlParams.get('model');

        if (modelPath) {
            const scene = new THREE.Scene();
            const camera = new THREE.Camera();
            scene.add(camera);

            const renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
            });

            arToolkitSource.init(() => {
                setTimeout(() => {
                    onResize();
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 1000)
            });

            window.addEventListener('resize', onResize);

            function onResize() {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
                }
            }

            const arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'data/camera_para.dat',
                detectionMode: 'mono',
            });

            arToolkitContext.init(() => {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });

            const markerRoot = new THREE.Group();
            scene.add(markerRoot);

            const markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'pattern',
                patternUrl: 'data/hiro.patt',
            });

            const ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xffffff, 0.8);
            camera.add(pointLight);

            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.setPath(modelPath.substring(0, modelPath.lastIndexOf('/') + 1));
            mtlLoader.load(modelPath.replace('.obj', '.mtl'), (materials) => {
                materials.preload();
                const objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                objLoader.setPath(modelPath.substring(0, modelPath.lastIndexOf('/') + 1));
                objLoader.load(modelPath.substring(modelPath.lastIndexOf('/') + 1), (object) => {
                    object.scale.set(0.5, 0.5, 0.5);
                    markerRoot.add(object);
                });
            });

            function animate() {
                requestAnimationFrame(animate);
                if (arToolkitSource.ready === false) return;
                arToolkitContext.update(arToolkitSource.domElement);
                renderer.render(scene, camera);
            }

            animate();
        } else {
            document.body.innerHTML = "<h1>No model specified.</h1>";
        }
    </script>

</body>
</html>
