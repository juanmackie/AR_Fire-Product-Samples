<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBJ Model Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: "Inter", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        canvas {
            display: block;
            width: 100%;
            height: calc(100vh - 100px); /* Adjust height for controls */
            background-color: #2d3748; /* Slightly lighter dark background for canvas */
            border-radius: 0.75rem; /* rounded-xl */
        }
        .controls-container {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
        }
        select {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #718096;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.5); /* Blue glow */
        }
    </style>
</head>
<body>

    <div class="controls-container">
        <h1 class="text-3xl font-bold mb-4">3D Model Viewer</h1>
        <label for="model-select" class="text-lg">Select a Model:</label>
        <select id="model-select" class="shadow-lg">
            <!-- Options will be populated by JavaScript -->
        </select>
        <div id="loading-message" class="text-yellow-400 mt-2 hidden">Loading model...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three-obj-loader@1.1.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three-mtl-loader@1.0.2/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // Global variables for Three.js scene
        let scene, camera, renderer, controls;
        let currentModel = null;
        let modelContainer = new THREE.Object3D(); // Use an empty object to hold and manipulate the loaded model
        const loadingMessage = document.getElementById('loading-message');

        // Define your OBJ models here. You'll need to host these files or make them accessible.
        // For demonstration, I'm using placeholder URLs. Replace them with your actual model paths.
        // Make sure the .obj and .mtl files are in the same directory or adjust the paths accordingly.
        const models = {
            // CORRECTED THE MTL PATH HERE
            'fish-2': { obj: 'models/fish-2.obj', mtl: 'models/fish-2.mtl', scale: 0.25 },
            // Add more models here, e.g.:
            // 'another-model': { obj: 'path/to/another-model.obj', mtl: 'path/to/another-model.mtl', scale: 1 },
            // 'third-model': { obj: 'path/to/third-model.obj', mtl: 'path/to/third-model.mtl', scale: 0.5 },
        };

        // Initialize the 3D scene
        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2d3748); // Canvas background color

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight - 100); // Adjust for controls
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 10, 5);
            scene.add(directionalLight);

            // OrbitControls for interaction
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // Smooth movements
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2; // Prevent camera from going below the ground

            // Add the model container to the scene
            scene.add(modelContainer);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);

            // Populate the dropdown and load the first model
            populateModelDropdown();
            loadModel('fish-2'); // Load default model on startup
        }

        // Handle window resize events
        function onWindowResize() {
            camera.aspect = window.innerWidth / (window.innerHeight - 100);
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight - 100);
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // Only required if controls.enableDamping or controls.autoRotate are set to true
            renderer.render(scene, camera);
        }

        // Function to load an OBJ model
        function loadModel(modelName) {
            if (currentModel) {
                modelContainer.remove(currentModel); // Remove previous model
                currentModel.traverse(child => {
                    if (child.isMesh) {
                        child.geometry.dispose();
                        if (child.material.map) child.material.map.dispose();
                        child.material.dispose();
                    }
                });
                currentModel = null;
            }

            loadingMessage.classList.remove('hidden'); // Show loading message

            const modelInfo = models[modelName];
            if (!modelInfo) {
                console.error(`Model "${modelName}" not found in configurations.`);
                loadingMessage.classList.add('hidden');
                return;
            }

            // OBJLoader instance
            const objLoader = new THREE.OBJLoader();
            // MTLLoader instance
            const mtlLoader = new THREE.MTLLoader();

            mtlLoader.setPath(modelInfo.mtl.substring(0, modelInfo.mtl.lastIndexOf('/') + 1));
            objLoader.setPath(modelInfo.obj.substring(0, modelInfo.obj.lastIndexOf('/') + 1));


            mtlLoader.load(modelInfo.mtl, function (materials) {
                materials.preload();
                objLoader.setMaterials(materials);

                objLoader.load(modelInfo.obj, function (object) {
                    currentModel = object;

                    // Adjust scale based on modelInfo
                    const scaleFactor = modelInfo.scale || 1; // Default to 1 if no scale is specified
                    currentModel.scale.set(scaleFactor, scaleFactor, scaleFactor);

                    // Center the model after loading
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    currentModel.position.sub(center); // Move model so its center is at (0,0,0) relative to its parent

                    modelContainer.add(currentModel);
                    loadingMessage.classList.add('hidden'); // Hide loading message
                    controls.target.copy(modelContainer.position); // Set controls target to the center of the loaded model
                    controls.update();

                }, onProgress, onError);
            }, onProgress, onError);
        }

        // Progress handler
        function onProgress(xhr) {
            if (xhr.lengthComputable) {
                const percentComplete = xhr.loaded / xhr.total * 100;
                loadingMessage.textContent = `Loading model: ${Math.round(percentComplete)}% loaded...`;
            }
        }

        // Error handler
        function onError(error) {
            console.error('An error occurred loading the model:', error);
            loadingMessage.textContent = 'Error loading model.';
            loadingMessage.classList.remove('hidden');
        }

        // Populate the model dropdown
        function populateModelDropdown() {
            const modelSelect = document.getElementById('model-select');
            for (const key in models) {
                if (models.hasOwnProperty(key)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format name for display
                    modelSelect.appendChild(option);
                }
            }
            modelSelect.addEventListener('change', (event) => {
                loadModel(event.target.value);
            });
        }

        // Initialize the app when the window loads
        window.onload = function() {
            init();
            animate();
        };
    </script>
</body>
</html>
